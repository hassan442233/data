<!DOCTYPE html> 
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title id="pageTitle">ุจูุงู ุฏุฑุฌุงุช ุงูุทุงูุจ ููุตููู</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/xlsx.full.min.js';
            document.head.appendChild(script);
        }
    </script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        if (typeof html2canvas === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/html2canvas.min.js';
            document.head.appendChild(script);
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        if (typeof jspdf === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/jspdf.umd.min.js';
            document.head.appendChild(script);
        }
    </script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f0f0f0;
      padding: 20px;
      text-align: center;
    }
    input, select, button {
      margin: 10px;
      padding: 12px 20px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .a4-container {
      width: 210mm;
      height: 297mm;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
      transform-origin: top center;
    }
    .scaled-content {
      width: 100%;
      height: 100%;
      transform: scale(0.85);
      transform-origin: top center;
    }
    h3, h4 {
      margin: 10px 0;
      color: #333;
    }
    .info {
      text-align: right;
      font-size: 16px;
      margin: 5px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #343a40;
      color: white;
    }
    .grade-blue { background-color: #007bff; color: white; }
    .grade-green { background-color: #28a745; color: white; }
    .grade-yellow { background-color: #ffc107; color: black; }
    .grade-red { background-color: #dc3535; color: white; }
    .highlight-total { background-color: #5a5a5a; color: white; }
    .signatures {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      font-size: 14px;
      padding: 0 20px;
    }
    .download-btn {
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .a4-container {
        width: 100%;
        height: auto;
        transform: scale(1);
        padding: 10px;
      }
      .scaled-content {
        transform: none;
      }
      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <h2>ุงูุงุณุชุนูุงู ุนู ูุชูุฌุฉ ุงูุทุงูุจ</h2>

  <label for="gradeFileSelector">ุงุฎุชุฑ ุงูุตู ุงูุฏุฑุงุณู:</label>
  <select id="gradeFileSelector" onchange="loadSelectedGradeFile()">
      <option value="">ุงุฎุชุฑ ุงูุตู ุงูุฏุฑุงุณู ูุชุญููู ููู ุงูุจูุงูุงุช</option>
      <option value="ุงูุงูู ุงูุงุจุชุฏุงุฆู">ุงูุฃูู ุงูุงุจุชุฏุงุฆู</option>
      <option value="ุงูุซุงูู ุงูุงุจุชุฏุงุฆู">ุงูุซุงูู ุงูุงุจุชุฏุงุฆู</option>
      <option value="ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู">ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู</option>
      <option value="ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู">ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู</option>
      <option value="ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู">ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู</option>
      <option value="ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู">ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู</option>
      <option value="ุงูุงูู ุงูุงุนุฏุงุฏู">ุงูุฃูู ุงูุฅุนุฏุงุฏู</option>
      <option value="ุงูุซุงูู ุงูุงุนุฏุงุฏู">ุงูุซุงูู ุงูุฅุนุฏุงุฏู</option>
      <option value="ุงูุซุงูุซ ุงูุงุนุฏุงุฏู">ุงูุซุงูุซ ุงูุฅุนุฏุงุฏู</option>
  </select>

  <br />
  <label for="yearSelector">ุงุฎุชุฑ ุงูุนุงู ุงูุฏุฑุงุณู (ูุฑูุฉ ุงูุนูู):</label>
  <select id="yearSelector" onchange="loadSheet()">
    <option value="">ุงุฎุชุฑ ุนุงููุง ุฏุฑุงุณููุง</option>
  </select>
  <select id="searchType">
    <option value="ุงูุฅุณู" selected>ุจุญุซ ุจุงูุงุณู</option>
    <option value="ุฑูู ุงูุฌููุณ">ุจุญุซ ุจุฑูู ุงูุฌููุณ</option>
  </select>
  <input type="text" id="searchInput" placeholder="ุฃุฏุฎู ุงูุงุณู ุฃู ุฑูู ุงูุฌููุณ" list="nameSuggestions" />
  <datalist id="nameSuggestions"></datalist>
  <button onclick="search()">ุงุนุฑุถ ุงููุชูุฌุฉ</button>
  <select id="gradeFilter" onchange="filterByGrade()">
    <option value="">ุนุฑุถ ูุชูุฌุฉ ุตู ุฏุฑุงุณู ูุงูู </option>
  </select>
  <hr />
  <br />
  <button class="download-btn" onclick="downloadImage()">๐ธ ุชุญููู ูุทุจุงุนุฉ ุงููุชูุฌุฉ </button>
  <button class="download-btn" onclick="downloadPDF()">๐ ุชุญููู ุงููุชูุฌุฉ ูููู PDF</button>
  <button class="download-btn" onclick="downloadAndShareWhatsapp()">๐ข ุชุญููู ููุดุงุฑูุฉ ุนูู ูุงุชุณุงุจ</button>

  <div id="result"></div>

  <script>
    let sheetData = [];
    let maxGrades = {};
    let allWorksheets = {}; // ูุชุฎุฒูู ุฌููุน ุฃูุฑุงู ุงูุนูู
    let currentYear = ""; // ูุชุฎุฒูู ุงูุนุงู ุงูุฏุฑุงุณู ุงูุญุงูู
    let currentGradeFile = ""; // ูุชุฎุฒูู ุงุณู ููู ุงูุตู ุงูุญุงูู

    function normalize(str) {
      return (str || "").replace(/ุฃ|ุฅ|ุข/g, "ุง").replace(/\s+/g, ' ').trim();
    }

    function getNextGrade(currentGrade) {
      const gradesOrder = [
        "ุงูุงูู ุงูุงุจุชุฏุงุฆู", "ุงูุซุงูู ุงูุงุจุชุฏุงุฆู", "ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู",
        "ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู", "ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู", "ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู",
        "ุงูุงูู ุงูุงุนุฏุงุฏู", "ุงูุซุงูู ุงูุงุนุฏุงุฏู", "ุงูุซุงูุซ ุงูุงุนุฏุงุฏู",
        "ุงูุงูู ุงูุซุงููู", "ุงูุซุงูู ุงูุซุงููู", "ุงูุซุงูุซ ุงูุซุงููู"
      ];
      const cleanGrade = normalize(currentGrade);
      const index = gradesOrder.findIndex(g => normalize(g) === cleanGrade);
      return (index !== -1 && index < gradesOrder.length - 1) ? gradesOrder[index + 1] : "โ";
    }

    function isPrimaryStage(grade) {
      return normalize(grade).includes("ุงูุงุจุชุฏุงุฆู");
    }

    function getPrimaryGradeText(percent) {
      if (percent >= 85) return "ุงุฒุฑู";
      else if (percent >= 65) return "ุงุฎุถุฑ";
      else if (percent >= 50) return "ุงุตูุฑ";
      else return "ุฃุญูุฑ";
    }

    function getSecondaryGradeText(percent) {
      if (percent >= 85) return "ููุชุงุฒ";
      else if (percent >= 75) return "ุฌูุฏ ุฌุฏุงู";
      else if (percent >= 65) return "ุฌูุฏ";
      else if (percent >= 50) return "ููุจูู";
      else return "ุฏูู ุงููุณุชูู";
    }
    
    // ุงูุฏุงูุฉ ูุชุญุฏูุฏ ุงุณู ุงูููู ุจูุงุกู ุนูู ุงูุตู ุงููุฎุชุงุฑ ูููุทู ุงูุชุฌููุน
    function getFileNameForGrade(selectedGrade) {
        let fileName = '';
        const grade = normalize(selectedGrade);
        
        if (grade === normalize("ุงูุงูู ุงูุงุจุชุฏุงุฆู") || grade === normalize("ุงูุซุงูู ุงูุงุจุชุฏุงุฆู")) {
            // ุงูุตู ุงูุฃูู ุฃู ุงูุซุงูู ุงูุงุจุชุฏุงุฆู
            fileName = "ุงูุฃูู ูุงูุซุงูู ุจ.xlsx";
        } else if (grade === normalize("ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู")) {
            // ุงูุตู ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู
            fileName = "ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู.xlsx";
        } else if (
            grade === normalize("ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู") ||
            grade === normalize("ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู") ||
            grade === normalize("ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู")
        ) {
            // ุงูุตู ุงูุฑุงุจุน ุฃู ุงูุฎุงูุณ ุฃู ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู
            fileName = "ุงูุฑุงุจุน ูุงูุฎุงูุณ ูุงูุณุงุฏุณ.xlsx";
        } else if (
            grade === normalize("ุงูุงูู ุงูุงุนุฏุงุฏู") ||
            grade === normalize("ุงูุซุงูู ุงูุงุนุฏุงุฏู") ||
            grade === normalize("ุงูุซุงูุซ ุงูุงุนุฏุงุฏู")
        ) {
            // ุงููุฑุญูุฉ ุงูุฅุนุฏุงุฏูุฉ
            fileName = "ุงููุฑุญูุฉ ุงูุฅุนุฏุงุฏูุฉ.xlsx";
        }

        if (fileName) {
            // ุฅุถุงูุฉ ุงููุณุงุฑ ุงูุฌุฏูุฏ (ูููุฏุฑ Data)
            return `Data/${fileName}`; 
        }
        return '';
    }

    // ุฏุงูุฉ ููุนุงูุฌุฉ ููู ุงูุฅูุณู ุจุนุฏ ุชุญูููู
    function processWorkbook(workbook) {
        allWorksheets = {}; 
        const yearSelector = document.getElementById("yearSelector");
        yearSelector.innerHTML = '<option value="">ุงุฎุชุฑ ุนุงููุง ุฏุฑุงุณููุง</option>'; 
        
        workbook.SheetNames.forEach(sheetName => {
          allWorksheets[sheetName] = workbook.Sheets[sheetName];
          const option = document.createElement('option');
          option.value = sheetName;
          option.textContent = sheetName;
          yearSelector.appendChild(option);
        });

        if (workbook.SheetNames.length > 0) {
          yearSelector.value = workbook.SheetNames[0];
          loadSheet(); 
        }

        alert(`โ ุชู ุชุญููู ููู ุงูุจูุงูุงุช (${currentGradeFile}) ุจูุฌุงุญ!`);
    }

    // ุฏุงูุฉ ุฌุฏูุฏุฉ ูุชุญููู ููู ุงูุฅูุณู ุจูุงุกู ุนูู ุงุฎุชูุงุฑ ุงูุตู
    async function loadSelectedGradeFile() {
        const gradeSelector = document.getElementById("gradeFileSelector");
        const selectedGrade = gradeSelector.value;
        
        // ูุณุญ ุงูุจูุงูุงุช ุงููุฏููุฉ ุนูุฏ ุชุบููุฑ ุงูุตู
        sheetData = [];
        allWorksheets = {};
        document.getElementById("yearSelector").innerHTML = '<option value="">ุงุฎุชุฑ ุนุงููุง ุฏุฑุงุณููุง</option>';
        document.getElementById("result").innerHTML = '';
        currentGradeFile = ""; 

        if (!selectedGrade) {
            return; 
        }

        const filePath = getFileNameForGrade(selectedGrade);
        
        if (!filePath) {
            alert("โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงุณู ููู ุฅูุณู ููุงุณุจ ููุตู ุงูุฏุฑุงุณู ุงููุฎุชุงุฑ.");
            return;
        }

        currentGradeFile = filePath; 

        try {
            // ุงุณุชุฎุฏุงู fetch API ูุชุญููู ููู ุงูุฅูุณู
            const response = await fetch(filePath);
            
            if (!response.ok) {
                // ุฑุณุงูุฉ ุฎุทุฃ ูู ุญุงู ุนุฏู ุงูุนุซูุฑ ุนูู ุงูููู
                throw new Error(`ูู ูุชู ุงูุนุซูุฑ ุนูู ููู: ${filePath}. ุชุฃูุฏ ูู ูุฌูุฏู ูู ูุฌูุฏ Data.`);
            }

            const data = await response.arrayBuffer();
            const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
            
            processWorkbook(workbook);

        } catch (error) {
            alert("โ ุฎุทุฃ ูู ุชุญููู ููู ุงูุฅูุณู. ุชุญูู ูู ุงุณู ุงูููู ูุงููุณุงุฑ ูู ูุฌูุฏ Data. \n" + error.message);
            console.error(error);
        }
    }


    // ุฏุงูุฉ ูุชุญููู ุจูุงูุงุช ูุฑูุฉ ุงูุนูู ุงููุญุฏุฏุฉ ูุชุญุฏูุซ ุนูุงุตุฑ ุงูุตูุญุฉ
    function loadSheet() {
      const yearSelector = document.getElementById("yearSelector");
      const sheetName = yearSelector.value;
      if (!sheetName) {
          sheetData = []; 
          maxGrades = {};
          document.getElementById("nameSuggestions").innerHTML = '';
          document.getElementById("gradeFilter").innerHTML = '<option value=""> ุนุฑุถ ูุชูุฌุฉ ุตู ุฏุฑุงุณู ูุงูู </option>';
          document.getElementById("result").innerHTML = '';
          const gradeSelector = document.getElementById("gradeFileSelector");
          const selectedGradeName = gradeSelector.options[gradeSelector.selectedIndex].text;
          document.getElementById("pageTitle").textContent = `ุจูุงู ุฏุฑุฌุงุช ุงูุทุงูุจ ููุตููู`;
          currentYear = "";
          return;
      }

      currentYear = sheetName;
      // ุชุญุฏูุซ ุนููุงู ุงูุตูุญุฉ ุจุงูุนุงู ุงูุฏุฑุงุณู ุงููุฎุชุงุฑ
      const pageTitleElement = document.getElementById("pageTitle");
      const gradeSelector = document.getElementById("gradeFileSelector");
      const selectedGradeName = gradeSelector.options[gradeSelector.selectedIndex].text;
      
      if (pageTitleElement) { 
          pageTitleElement.textContent = `ุจูุงู ุฏุฑุฌุงุช ุงูุทุงูุจ ููุตู ${selectedGradeName} ููุนุงู ุงูุฏุฑุงุณู ${currentYear}`;
      }

      const worksheet = allWorksheets[sheetName];

      const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      const headers = rawData[0];
      const secondRow = rawData[1];
      maxGrades = {};
      headers.forEach((key, index) => {
        if (key && typeof secondRow[index] === 'number') {
          maxGrades[key] = secondRow[index];
        }
      });

      const studentData = rawData.slice(2);
      sheetData = studentData.map(row => {
        const obj = {};
        headers.forEach((key, i) => obj[key] = row[i]);
        return obj;
      });

      // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงูุชุฑุงุญุงุช (datalist)
      const datalist = document.getElementById("nameSuggestions");
      datalist.innerHTML = '';
      sheetData.forEach(student => {
        if (student["ุงูุฅุณู"]) {
          const option = document.createElement('option');
          option.value = student["ุงูุฅุณู"];
          datalist.appendChild(option);
        }
      });

      // ุชุญุฏูุซ ููุชุฑ ุงูุตู ุงูุฏุฑุงุณู
      const gradeFilter = document.getElementById("gradeFilter");
      const uniqueGrades = [...new Set(sheetData.map(s => s["ุงูุตู"]).filter(Boolean))];
      gradeFilter.innerHTML = `<option value=""> ุนุฑุถ ูุชูุฌุฉ ุตู ุฏุฑุงุณู ูุงูู </option>`;
      uniqueGrades.forEach(grade => {
        const option = document.createElement("option");
        option.value = grade;
        option.textContent = grade;
        gradeFilter.appendChild(option);
      });
      document.getElementById('result').innerHTML = ''; // ูุณุญ ุงููุชุงุฆุฌ ุงููุนุฑูุถุฉ ุนูุฏ ุชุบููุฑ ุงูุนุงู
    }

    function getGradeClass(percent) {
      if (percent >= 85) return "grade-blue";
      else if (percent >= 65) return "grade-green";
      else if (percent >= 50) return "grade-yellow";
      else return "grade-red";
    }

    function generateStudentCard(student) {
      const ignoredKeys = ["ุฑูู ุงูุฌููุณ", "ุงูุฅุณู", "ุชุฑุชูุจ ุงูุทุงูุจ", "ุงูุตู"];
      const subjects = Object.keys(student).filter(k => !ignoredKeys.includes(k));
      const nextGrade = getNextGrade(student["ุงูุตู"]);
      const allSubjects = [...subjects];

      let html = `<div class="a4-container" id="card-result"><div class="scaled-content">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
          <div style="text-align: right;">
            <h3 style="margin: 0;">ุฅุฏุงุฑุฉ ุงููููุง ุงูุชุนููููุฉ</h3>
            <h4 style="margin: 0;">ูุฏุฑุณุฉ ุตูุงุญ ุงูุฏูู ุงูุฅุณูุงููุฉ ุงูุฎุงุตุฉ</h4>
          </div>
          <div>
              </div>
        </div>
        <hr style="border: 1px solid #000;"/>
        <div style="text-align: right; padding: 0 10px;">
          <p class="info"><strong>ุงูุงุณู:</strong> ${student["ุงูุฅุณู"] || 'ุบูุฑ ูุชููุฑ'}</p>
          <p class="info"><strong>ุฑูู ุงูุฌููุณ:</strong> ${student["ุฑูู ุงูุฌููุณ"] || 'ุบูุฑ ูุชููุฑ'}</p>
          <p class="info"><strong>ุงูุตู ุงูุฏุฑุงุณู:</strong> ${student["ุงูุตู"] || 'ุบูุฑ ูุชููุฑ'}</p>
          <p class="info"><strong>ุงูุชุฑุชูุจ ุนูู ุงูุตู:</strong> ${student["ุชุฑุชูุจ ุงูุทุงูุจ"] || 'โ'}</p>
          <p class="info"><strong>ุงูุนุงู ุงูุฏุฑุงุณู:</strong> ${currentYear || 'ุบูุฑ ูุชููุฑ'}</p>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>ุงููุงุฏุฉ</th>
              <th>ุงูุฏุฑุฌุฉ ุงููููุฉ</th>
              <th>ุฏุฑุฌุฉ ุงูุทุงูุจ</th>
              <th>ุงูุชูุฏูุฑ</th>
            </tr>
          </thead>
          <tbody>`;

      let totalScore = 0;
      let maxTotalScore = 0;

      subjects.forEach(subject => {
        const score = student[subject] || 0;
        const max = maxGrades[subject] || 1;
        const percent = (score / max) * 100;
        const gradeClass = getGradeClass(percent);
        const gradeText = isPrimaryStage(student["ุงูุตู"]) ? getPrimaryGradeText(percent) : getSecondaryGradeText(percent);

        totalScore += parseFloat(score) || 0;
        maxTotalScore += parseFloat(max) || 0;

        html += `<tr>
              <td style="text-align: right;">${subject}</td>
              <td>${max}</td>
              <td>${score}</td>
              <td class="${gradeClass}"><strong>${gradeText}</strong></td>
            </tr>`;
      });

      const overallPercent = maxTotalScore > 0 ? (totalScore / maxTotalScore) * 100 : 0;
      const overallGradeText = isPrimaryStage(student["ุงูุตู"]) ? getPrimaryGradeText(overallPercent) : getSecondaryGradeText(overallPercent);
      const overallGradeClass = getGradeClass(overallPercent);

      html += `
            <tr class="highlight-total">
              <td style="text-align: right;"><strong>ุงููุฌููุน ุงูููู</strong></td>
              <td><strong>${maxTotalScore}</strong></td>
              <td><strong>${totalScore}</strong></td>
              <td class="${overallGradeClass}"><strong>${overallGradeText} (${overallPercent.toFixed(2)}%)</strong></td>
            </tr>
            <tr>
              <td style="text-align: right;"><strong>ุงูุญุงูุฉ</strong></td>
              <td colspan="3" style="font-size: 16px;"><strong>${overallPercent >= 50 ? 'ูุงุฌุญ' : 'ุฑุงุณุจ'}</strong></td>
            </tr>
            <tr>
              <td style="text-align: right;"><strong>ุงูููููู ุฅูู</strong></td>
              <td colspan="3" style="font-size: 16px;"><strong>${overallPercent >= 50 ? nextGrade : 'โ'}</strong></td>
            </tr>
          </tbody>
        </table>

        <div class="signatures">
          <span>ุชูููุน ููู ุงูุฃูุฑ: ............................</span>
          <span>ุชูููุน ูุฏูุฑ ุงููุฏุฑุณุฉ: ............................</span>
        </div>
        <p style="position: absolute; bottom: 20px; left: 20px; font-size: 10px;">
          ุชุงุฑูุฎ ุงูุทุจุงุนุฉ: ${new Date().toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })}
        </p>

      </div></div>`;

      document.getElementById('result').innerHTML = html;
      
      const shareText = `ูุชูุฌุฉ ุงูุทุงูุจ: ${student["ุงูุฅุณู"]} - ุงูุตู: ${student["ุงูุตู"]} - ุงููุฌููุน: ${totalScore} ูู ${maxTotalScore} - ุงูุชูุฏูุฑ: ${overallGradeText} - ุงููุณุจุฉ: ${overallPercent.toFixed(2)}%`;
      document.querySelector('button[onclick="downloadAndShareWhatsapp()"]').setAttribute('data-share-text', shareText);
    }
    
    // ุฏุงูุฉ ุงูุจุญุซ (ูู ุชุชุบูุฑ)
    function search() {
      const input = document.getElementById("searchInput").value.trim();
      const searchType = document.getElementById("searchType").value;
      if (!input || sheetData.length === 0) {
        document.getElementById("result").innerHTML = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ูููุฉ ุจุญุซ ูุชุญููู ููู ุงูุจูุงูุงุช ุฃููุงู.';
        return;
      }

      const normalizedInput = normalize(input);

      const student = sheetData.find(s => {
        if (searchType === "ุงูุฅุณู") {
          return normalize(s["ุงูุฅุณู"]) === normalizedInput;
        } else if (searchType === "ุฑูู ุงูุฌููุณ") {
          return String(s["ุฑูู ุงูุฌููุณ"]) === normalizedInput;
        }
        return false;
      });

      if (student) {
        generateStudentCard(student);
      } else {
        document.getElementById("result").innerHTML = '<h3>โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุทุงูุจ ุจุงูุงุณู/ุฑูู ุงูุฌููุณ ุงููุฏุฎู.</h3>';
      }
    }
    
    // ุฏุงูุฉ ููุชุฑุฉ ุงูุตููู (ูู ุชุชุบูุฑ)
    function filterByGrade() {
        const grade = document.getElementById("gradeFilter").value;
        if (!grade) {
            document.getElementById("result").innerHTML = '';
            return;
        }

        const filteredStudents = sheetData.filter(s => s["ุงูุตู"] === grade);

        if (filteredStudents.length > 0) {
            let tableHtml = `<div class="a4-container" style="height: auto; width: 80%;"><div class="scaled-content" style="transform: none;">
                <h3 style="text-align: center;">ูุชุงุฆุฌ ุทูุงุจ ุงูุตู: ${grade} ููุนุงู ุงูุฏุฑุงุณู: ${currentYear}</h3>
                <table style="margin-bottom: 20px;"><thead><tr>
                    <th>ุงูุงุณู</th>
                    <th>ุฑูู ุงูุฌููุณ</th>
                    <th>ุงูุชุฑุชูุจ</th>
                    <th>ุงููุฌููุน ุงูููู</th>
                    <th>ุงูุชูุฏูุฑ ุงูููุงุฆู</th>
                </tr></thead><tbody>`;

            filteredStudents.forEach(student => {
                const ignoredKeys = ["ุฑูู ุงูุฌููุณ", "ุงูุฅุณู", "ุชุฑุชูุจ ุงูุทุงูุจ", "ุงูุตู"];
                const subjects = Object.keys(student).filter(k => !ignoredKeys.includes(k));
                let totalScore = 0;
                let maxTotalScore = 0;

                subjects.forEach(subject => {
                    const score = student[subject] || 0;
                    const max = maxGrades[subject] || 1;
                    totalScore += parseFloat(score) || 0;
                    maxTotalScore += parseFloat(max) || 0;
                });

                const overallPercent = maxTotalScore > 0 ? (totalScore / maxTotalScore) * 100 : 0;
                const overallGradeText = isPrimaryStage(grade) ? getPrimaryGradeText(overallPercent) : getSecondaryGradeText(overallPercent);
                const overallGradeClass = getGradeClass(overallPercent);

                tableHtml += `<tr>
                    <td style="text-align: right;">${student["ุงูุฅุณู"] || 'โ'}</td>
                    <td>${student["ุฑูู ุงูุฌููุณ"] || 'โ'}</td>
                    <td>${student["ุชุฑุชูุจ ุงูุทุงูุจ"] || 'โ'}</td>
                    <td>${totalScore} / ${maxTotalScore}</td>
                    <td class="${overallGradeClass}"><strong>${overallGradeText} (${overallPercent.toFixed(2)}%)</strong></td>
                </tr>`;
            });

            tableHtml += `</tbody></table></div></div>`;
            document.getElementById('result').innerHTML = tableHtml;
        } else {
            document.getElementById("result").innerHTML = '<h3>โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ููุฐุง ุงูุตู ุงูุฏุฑุงุณู.</h3>';
        }
    }

    // ุฏูุงู ุงูุชุญููู ูุงูุทุจุงุนุฉ (ูู ุชุชุบูุฑ)
    function downloadImage() {
      const card = document.getElementById("card-result");
      if (!card) return alert("ูู ูุถูู ุงุนุฑุถ ุงููุชูุฌุฉ ุฃููุง");
      const studentName = (document.querySelector('.info')?.innerText || 'ุงูุทุงูุจ').replace('ุงูุงุณู:', '').trim();
      html2canvas(card, { scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = `${studentName}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }

    function printResult() {
      const card = document.getElementById("card-result");
      if (!card) return alert("ูู ูุถูู ุงุนุฑุถ ุงููุชูุฌุฉ ุฃููุง");
      html2canvas(card, { scale: 2 }).then(canvas => {
        const img = canvas.toDataURL('image/png');
        const imgWindow = window.open('about:blank', 'printWindow', 'width=800,height=600');
        imgWindow.document.write('<html><head><title>ุทุจุงุนุฉ ุงููุชูุฌุฉ</title><style>@page { size: A4; margin: 0; } body { margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }</style></head><body><img src="' + img + '" style="max-width: 210mm; max-height: 297mm;" onload="window.print();window.close()"/></body></html>');
        imgWindow.document.close();
      });
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const card = document.getElementById("card-result");
      if (!card) return alert("ูู ูุถูู ุงุนุฑุถ ุงููุชูุฌุฉ ุฃููุง");
      const studentName = (document.querySelector('.info')?.innerText || 'ุงูุทุงูุจ').replace('ุงูุงุณู:', '').trim();
      html2canvas(card, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`${studentName}.pdf`);
      });
    }

    function downloadAndShareWhatsapp() {
      const card = document.getElementById("card-result");
      if (!card) return alert("ูู ูุถูู ุงุนุฑุถ ุงููุชูุฌุฉ ุฃููุง");

      // ูุฌูุจ ูุต ุงููุดุงุฑูุฉ ุงูุฐู ุชู ุฅุนุฏุงุฏู ูู ุฏุงูุฉ generateStudentCard
      const shareText = document.querySelector('button[onclick="downloadAndShareWhatsapp()"]').getAttribute('data-share-text') || "ูุชูุฌุฉ ุงูุทุงูุจ";
      
      // ุฅูุดุงุก ูุนุงุก ููุตูุฑุฉ ููุดุงุฑูุฉ ูุงุชุณุงุจ (ูุชุทูุจ ุฑูุน ุงูุตูุฑุฉ ุฃููุง)
      html2canvas(card, { scale: 2 }).then(canvas => {
        canvas.toBlob(blob => {
          if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'result.png', { type: blob.type })] })) {
            const file = new File([blob], 'result.png', { type: blob.type });
            navigator.share({
              files: [file],
              title: 'ูุชูุฌุฉ ุงูุทุงูุจ',
              text: shareText
            }).catch((error) => console.log('Sharing failed', error));
          } else {
            // ุญู ุจุฏูู: ูุชุญ ุฑุงุจุท ูุงุชุณุงุจ ุจูุต ููุท
            const whatsappLink = `https://wa.me/?text=${encodeURIComponent(shareText + "\n\n(ููุฃุณู ูุง ูููู ูุดุงุฑูุฉ ุงูุตูุฑุฉ ูุจุงุดุฑุฉ ุนุจุฑ ุงููุชุตูุญ ุงูุฎุงุต ุจูุ ููููู ุชุญููููุง ููุดุงุฑูุชูุง ูุฏููุงู.)")}`;
            window.open(whatsappLink, '_blank');
          }
        }, 'image/png');
      });
    }
  </script>
</body>
</html>