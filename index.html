<!DOCTYPE html> 
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¨ÙŠØ§Ù† Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/xlsx.full.min.js'; // Ù…Ø³Ø§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            document.head.appendChild(script);
        }
    </script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        if (typeof html2canvas === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/html2canvas.min.js'; // Ù…Ø³Ø§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            document.head.appendChild(script);
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        if (typeof jspdf === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/jspdf.umd.min.js'; // Ù…Ø³Ø§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ
            document.head.appendChild(script);
        }
    </script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f0f0f0;
      padding: 20px;
      text-align: center;
    }
    input, select, button {
      margin: 10px;
      padding: 12px 20px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .a4-container {
      width: 210mm;
      height: 297mm;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
      transform-origin: top center;
    }
    .scaled-content {
      width: 100%;
      height: 100%;
      transform: scale(0.85);
      transform-origin: top center;
    }
    h3, h4 {
      margin: 10px 0;
      color: #333;
    }
    .info {
      text-align: right;
      font-size: 16px;
      margin: 5px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #343a40;
      color: white;
    }
    .grade-blue { background-color: #007bff; color: white; }
    .grade-green { background-color: #28a745; color: white; }
    .grade-yellow { background-color: #ffc107; color: black; }
    .grade-red { background-color: #dc3545; color: white; }
    .highlight-total { background-color: #5a5a5a; color: white; }
    .signatures {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      font-size: 14px;
      padding: 0 20px;
    }
    .download-btn {
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .a4-container {
        width: 100%;
        height: auto;
        transform: scale(1);
        padding: 10px;
      }
      .scaled-content {
        transform: none;
      }
      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <h2>Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>

  <label for="gradeFileSelector">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</label>
  <select id="gradeFileSelector" onchange="loadSelectedGradeFile()">
    <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
    <option value="Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
    <option value="Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
    <option value="Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
    <option value="Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
    <option value="Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
  </select>
  <br />

  <label for="yearSelector">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</label>
  <select id="yearSelector" onchange="loadSheet()">
    <option value="">Ø§Ø®ØªØ± Ø¹Ø§Ù…Ù‹Ø§ Ø¯Ø±Ø§Ø³ÙŠÙ‹Ø§</option>
  </select>
  <select id="searchType">
    <option value="Ø§Ù„Ø¥Ø³Ù…" selected>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</option>
    <option value="Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³">Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</option>
  </select>
  <input type="text" id="searchInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³" list="nameSuggestions" />
  <datalist id="nameSuggestions"></datalist>
  <button onclick="search()">Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
  <select id="gradeFilter" onchange="filterByGrade()">
    <option value="">Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© ØµÙ Ø¯Ø±Ø§Ø³ÙŠ ÙƒØ§Ù…Ù„ </option>
  </select>
  <hr />
  <br />
  <button class="download-btn" onclick="downloadImage()">ğŸ“¸ ØªØ­Ù…ÙŠÙ„ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© </button>
  <button class="download-btn" onclick="downloadPDF()">ğŸ“• ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒÙ…Ù„Ù PDF</button>
  <button class="download-btn" onclick="downloadAndShareWhatsapp()">ğŸŸ¢ ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</button>

  <div id="result"></div>

  <script>
    let sheetData = [];
    let maxGrades = {};
    let allWorksheets = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„
    let currentYear = ""; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
    let currentGradeFile = ""; // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ù„ÙŠ

    function normalize(str) {
      return (str || "").replace(/Ø£|Ø¥|Ø¢/g, "Ø§").replace(/\s+/g, ' ').trim();
    }

    function getNextGrade(currentGrade) {
      const gradesOrder = [
        "Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
        "Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
        "Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ",
        "Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"
      ];
      const cleanGrade = normalize(currentGrade);
      const index = gradesOrder.findIndex(g => normalize(g) === cleanGrade);
      return (index !== -1 && index < gradesOrder.length - 1) ? gradesOrder[index + 1] : "â€”";
    }

    function isPrimaryStage(grade) {
      return normalize(grade).includes("Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ");
    }

    function getPrimaryGradeText(percent) {
      if (percent >= 85) return "Ø§Ø²Ø±Ù‚";
      else if (percent >= 65) return "Ø§Ø®Ø¶Ø±";
      else if (percent >= 50) return "Ø§ØµÙØ±";
      else return "Ø£Ø­Ù…Ø±";
    }

    function getSecondaryGradeText(percent) {
      if (percent >= 85) return "Ù…Ù…ØªØ§Ø²";
      else if (percent >= 75) return "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹";
      else if (percent >= 65) return "Ø¬ÙŠØ¯";
      else if (percent >= 50) return "Ù…Ù‚Ø¨ÙˆÙ„";
      else return "Ø¯ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙˆÙ‰";
    }

    // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙˆÙ…Ù†Ø·Ù‚ Ø§Ù„ØªØ¬Ù…ÙŠØ¹
    function getFileNameForGrade(selectedGrade) {
        let fileName = '';
        const grade = normalize(selectedGrade);
        
        if (grade === normalize("Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ") || grade === normalize("Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ")) {
            fileName = "Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø«Ø§Ù†ÙŠ Ø¨.xlsx";
        } else if (grade === normalize("Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ")) {
            fileName = "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ.xlsx";
        } else if (
            grade === normalize("Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ") ||
            grade === normalize("Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ") ||
            grade === normalize("Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ")
        ) {
            fileName = "Ø§Ù„Ø±Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø®Ø§Ù…Ø³ ÙˆØ§Ù„Ø³Ø§Ø¯Ø³.xlsx";
        } else if (
            grade === normalize("Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ") ||
            grade === normalize("Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ") ||
            grade === normalize("Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ")
        ) {
            fileName = "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©.xlsx";
        }

        if (fileName) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ÙÙˆÙ„Ø¯Ø± Data)
            return `Data/${fileName}`; 
        }
        return '';
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„Ù‡
    function processWorkbook(workbook) {
        allWorksheets = {}; 
        const yearSelector = document.getElementById("yearSelector");
        yearSelector.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¹Ø§Ù…Ù‹Ø§ Ø¯Ø±Ø§Ø³ÙŠÙ‹Ø§</option>'; 
        
        workbook.SheetNames.forEach(sheetName => {
          allWorksheets[sheetName] = workbook.Sheets[sheetName];
          const option = document.createElement('option');
          option.value = sheetName;
          option.textContent = sheetName;
          yearSelector.appendChild(option);
        });

        if (workbook.SheetNames.length > 0) {
          yearSelector.value = workbook.SheetNames[0];
          loadSheet(); 
        }

        alert(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (${currentGradeFile || "Ø§Ù„Ù…Ù„Ù"}) Ø¨Ù†Ø¬Ø§Ø­!`);
    }

    // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ
    async function loadSelectedGradeFile() {
        const gradeSelector = document.getElementById("gradeFileSelector");
        const selectedGrade = gradeSelector.value;
        
        // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ
        sheetData = [];
        allWorksheets = {};
        document.getElementById("yearSelector").innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¹Ø§Ù…Ù‹Ø§ Ø¯Ø±Ø§Ø³ÙŠÙ‹Ø§</option>';
        document.getElementById("result").innerHTML = '';
        currentGradeFile = ""; 

        if (!selectedGrade) {
            return; 
        }

        const filePath = getFileNameForGrade(selectedGrade);
        
        if (!filePath) {
            alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ù…Ù„Ù Ø¥ÙƒØ³Ù„ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù…Ø®ØªØ§Ø±.");
            return;
        }

        currentGradeFile = filePath; 

        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch API Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„
            const response = await fetch(filePath);
            
            if (!response.ok) {
                // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù
                throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù: ${filePath}. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡ ÙÙŠ Ù…Ø¬Ù„Ø¯ Data.`);
            }

            const data = await response.arrayBuffer();
            const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
            
            processWorkbook(workbook);

        } catch (error) {
            alert("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„Ù…Ø³Ø§Ø± ÙÙŠ Ù…Ø¬Ù„Ø¯ Data. \n" + error.message);
            console.error(error);
        }
    }
    
    // ØªÙ… Ø­Ø°Ù ÙƒÙˆØ¯ "document.getElementById('upload').addEventListener('change', ..."

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
    function loadSheet() {
      const yearSelector = document.getElementById("yearSelector");
      const sheetName = yearSelector.value;
      if (!sheetName) {
          sheetData = []; // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø§Ù… Ø¯Ø±Ø§Ø³ÙŠ
          maxGrades = {};
          document.getElementById("nameSuggestions").innerHTML = '';
          document.getElementById("gradeFilter").innerHTML = '<option value=""> Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© ØµÙ Ø¯Ø±Ø§Ø³ÙŠ ÙƒØ§Ù…Ù„ </option>';
          document.getElementById("result").innerHTML = '';
          // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†ØµØ± Ø¨Ù€ ID "pageTitle" ÙÙŠ HTML Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ù„Ø°Ø§ Ù‚Ù…Øª Ø¨Ø¥Ø²Ø§Ù„ØªÙ‡ Ù…Ù† Ù‡Ù†Ø§.
          currentYear = "";
          return;
      }

      currentYear = sheetName;
      // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù…Ø®ØªØ§Ø± (ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©)

      const worksheet = allWorksheets[sheetName];

      const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      const headers = rawData[0];
      const secondRow = rawData[1];
      maxGrades = {};
      headers.forEach((key, index) => {
        if (key && typeof secondRow[index] === 'number') {
          maxGrades[key] = secondRow[index];
        }
      });

      const studentData = rawData.slice(2);
      sheetData = studentData.map(row => {
        const obj = {};
        headers.forEach((key, i) => obj[key] = row[i]);
        return obj;
      });

      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª (datalist)
      const datalist = document.getElementById("nameSuggestions");
      datalist.innerHTML = '';
      sheetData.forEach(student => {
        if (student["Ø§Ù„Ø¥Ø³Ù…"]) {
          const option = document.createElement('option');
          option.value = student["Ø§Ù„Ø¥Ø³Ù…"];
          datalist.appendChild(option);
        }
      });

      // ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
      const gradeFilter = document.getElementById("gradeFilter");
      const uniqueGrades = [...new Set(sheetData.map(s => s["Ø§Ù„ØµÙ"]).filter(Boolean))];
      gradeFilter.innerHTML = `<option value=""> Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© ØµÙ Ø¯Ø±Ø§Ø³ÙŠ ÙƒØ§Ù…Ù„ </option>`;
      uniqueGrades.forEach(grade => {
        const option = document.createElement("option");
        option.value = grade;
        option.textContent = grade;
        gradeFilter.appendChild(option);
      });
      document.getElementById('result').innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ù…
    }

    function getGradeClass(percent) {
      if (percent >= 85) return "grade-blue";
      else if (percent >= 65) return "grade-green";
      else if (percent >= 50) return "grade-yellow";
      else return "grade-red";
    }

    function generateStudentCard(student) {
      const ignoredKeys = ["Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³", "Ø§Ù„Ø¥Ø³Ù…", "ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø§Ù„Ø¨", "Ø§Ù„ØµÙ"];
      const subjects = Object.keys(student).filter(k => !ignoredKeys.includes(k));
      const nextGrade = getNextGrade(student["Ø§Ù„ØµÙ"]);
      const allSubjects = [...subjects];

      let html = `<div class="a4-container" id="card-result"><div class="scaled-content">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
          <div style="text-align: right;">
            <h3 style="margin: 0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠØ§ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h3>
            <h4 style="margin: 0;">Ù…Ø¯Ø±Ø³Ø© ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ©</h4>
          </div>
          <div>
<img src="
              
                        " alt="Ù„ÙˆØ¬Ùˆ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" style="height: 80px;" />
          </div>
        </div>
        <h3 id="pageTitle" style="text-align: center;">Ø¨ÙŠØ§Ù† Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ${currentYear || "2023-2024"}</h3>
        <div class="info"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${student["Ø§Ù„Ø¥Ø³Ù…"]}</div>
        <div class="info"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³:</strong> ${student["Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³"]}</div>
        <div class="info"><strong>Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</strong> ${student["Ø§Ù„ØµÙ"]}</div>
        <table>
          <tr>
            <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
            ${allSubjects.map(sub => `<th>${sub}</th>`).join('')}
          </tr>
          <tr>
            <td>Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„ÙƒØ¨Ø±Ù‰</td>
            ${allSubjects.map(sub => {
              const val = maxGrades[sub] || '-';
              return sub === "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹"
                ? `<td class="highlight-total">${val}</td>`
                : `<td>${val}</td>`;
            }).join('')}
          </tr>
          <tr>
            <td>Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„ØµØºØ±Ù‰</td>
            ${allSubjects.map(sub => {
              const val = maxGrades[sub] ? maxGrades[sub] / 2 : '-';
              return sub === "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹"
                ? `<td class="highlight-total">${val}</td>`
                : `<td>${val}</td>`;
            }).join('')}
          </tr>
          <tr>
            <td>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</td>
            ${allSubjects.map(sub => {
              const value = typeof student[sub] === 'number' ? student[sub].toFixed(2) : student[sub];
              return sub === "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹"
                ? `<td class="highlight-total">${value}</td>`
                : `<td>${value}</td>`;
            }).join('')}
          </tr>
          <tr>
            <td>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</td>
            ${allSubjects.map(sub => {
              const mark = parseFloat(student[sub]);
              const max = maxGrades[sub] || 100;
              const percent = (mark / max) * 100;
              const text = isPrimaryStage(student["Ø§Ù„ØµÙ"])
                ? getPrimaryGradeText(percent)
                : getSecondaryGradeText(percent);
              const className = getGradeClass(percent);
              return `<td class="${className}">${text}</td>`;
            }).join('')}
          </tr>
          <tr>
            <td colspan="${allSubjects.length + 1}" style="background: #d4edda; color: #155724; font-weight: bold;">
              âœ… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ø§Ø¬Ø­ ÙˆÙ…Ù†Ù‚ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙ ${nextGrade}
            </td>
          </tr>
        </table>
        <div class="signatures">
          <div>Ù…. Ø§Ù„Ø­Ø§Ø³Ø¨<br><strong>Ø§Ù„Ø­Ø³Ù† Ø£Ø­Ù…Ø¯</strong></div>
          <div>Ø±Ø¦ÙŠØ³ Ù„Ø¬Ù†Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©<br><strong>Ø¨Ø¯Ø± Ø§Ù„Ø¯ÙŠÙ† Ø­Ø¨Ø´ÙŠ</strong></div>
          <div>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©<br><strong>Ø¨Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙŠÙ† Ù…Ø­Ù…Ø¯</strong></div>
        </div>
      </div></div>`;

      return html;
    }

    function search() {
      const type = document.getElementById('searchType').value;
      const value = document.getElementById('searchInput').value.trim();
      if (!value) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¨Ø­Ø«");
      if (sheetData.length === 0) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel ÙˆØ§Ø®ØªØ± Ø¹Ø§Ù…Ù‹Ø§ Ø¯Ø±Ø§Ø³ÙŠÙ‹Ø§ Ø£ÙˆÙ„Ø§Ù‹.");
      
      const student = sheetData.find(row => 
        type === "Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³" ? row["Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³"]?.toString() === value : 
        row["Ø§Ù„Ø¥Ø³Ù…"] && normalize(row["Ø§Ù„Ø¥Ø³Ù…"]).includes(normalize(value))
      );
      document.getElementById('result').innerHTML = student ? generateStudentCard(student) : "<p>âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø§Ù„Ø¨ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯.</p>";
    }

    function filterByGrade() {
      const selectedGrade = document.getElementById("gradeFilter").value;
      if (sheetData.length === 0) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel ÙˆØ§Ø®ØªØ± Ø¹Ø§Ù…Ù‹Ø§ Ø¯Ø±Ø§Ø³ÙŠÙ‹Ø§ Ø£ÙˆÙ„Ø§Ù‹.");
      if (!selectedGrade) {
          document.getElementById("result").innerHTML = "";
          return;
      }
      const filtered = sheetData.filter(s => s["Ø§Ù„ØµÙ"] === selectedGrade);
      document.getElementById("result").innerHTML = filtered.length === 0 ? "<p>âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØµÙ Ù„Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯.</p>" : filtered.map(generateStudentCard).join('');
    }

  function downloadImage() {
  const card = document.getElementById("card-result");
  if (!card) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£ÙˆÙ„Ø§");

  const studentName = (document.querySelector('.info')?.innerText || 'Ø§Ù„Ø·Ø§Ù„Ø¨')
    .replace('Ø§Ù„Ø§Ø³Ù…:', '').trim();

  html2canvas(card, { scale: 2 }).then(canvas => {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
    const link = document.createElement('a');
    link.download = `${studentName}.png`;
    link.href = canvas.toDataURL();
    link.click();

    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠÙ‡Ø§ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
    const imgWindow = window.open('', '_blank');
    const img = new Image();
    img.src = canvas.toDataURL();
    img.style.maxWidth = '100%';

    img.onload = function () {
      imgWindow.document.write(
        `<html>
          <head>
            <title style="color:white;"> Ù’</title>
            <style>
              @page { margin-top: 10mm; margin-left: 0; margin-right: 0; margin-bottom: 0; }
              body { margin:0; text-align:center; }
              title { color: white !important; }
            </style>
          </head>
          <body>
          </body>
        </html>`
      );
      imgWindow.document.body.appendChild(img);
      imgWindow.document.close();
      imgWindow.print();
    };
  });
}


    function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const card = document.getElementById("card-result");
  if (!card) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£ÙˆÙ„Ø§");
  const studentName = (document.querySelector('.info')?.innerText || 'Ø§Ù„Ø·Ø§Ù„Ø¨').replace('Ø§Ù„Ø§Ø³Ù…:', '').trim();
  html2canvas(card, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save(`${studentName}.pdf`);
  });
}


function downloadAndShareWhatsapp() {
  const card = document.getElementById("card-result");
  if (!card) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£ÙˆÙ„Ø§");

  // Ù†Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
  const studentName = (document.querySelector('.info strong')?.innerText || 'Ø§Ù„Ø·Ø§Ù„Ø¨').replace('Ø§Ù„Ø§Ø³Ù…:', '').trim();

  html2canvas(card, { scale: 2 }).then(canvas => {
    // Ù†Ø­Ù…Ù„ Ø§Ù„ØµÙˆØ±Ø©
    const link = document.createElement('a');
    link.download = `${studentName}.png`;
    link.href = canvas.toDataURL();
    link.click();

    // Ù†ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    setTimeout(() => {
      const message = encodeURIComponent(`ğŸ“š Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}`);
      window.open(`https://wa.me/?text=${message}`, '_blank');
    }, 1000);
  });
}


  </script>
</body>
</html>
