<!DOCTYPE html> 
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ุจูุงู ุฏุฑุฌุงุช ุงูุทุงูุจ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/xlsx.full.min.js'; // ูุณุงุฑ ุงุญุชูุงุทู
            document.head.appendChild(script);
        }
    </script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        if (typeof html2canvas === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/html2canvas.min.js'; // ูุณุงุฑ ุงุญุชูุงุทู
            document.head.appendChild(script);
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        if (typeof jspdf === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/jspdf.umd.min.js'; // ูุณุงุฑ ุงุญุชูุงุทู
            document.head.appendChild(script);
        }
    </script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f0f0f0;
      padding: 20px;
      text-align: center;
    }
    input, select, button {
      margin: 10px;
      padding: 12px 20px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .a4-container {
      width: 210mm;
      height: 297mm;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
      transform-origin: top center;
    }
    .scaled-content {
      width: 100%;
      height: 100%;
      transform: scale(0.85);
      transform-origin: top center;
    }
    h3, h4 {
      margin: 10px 0;
      color: #333;
    }
    .info {
      text-align: right;
      font-size: 16px;
      margin: 5px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #343a40;
      color: white;
    }
    .grade-blue { background-color: #007bff; color: white; }
    .grade-green { background-color: #28a745; color: white; }
    .grade-yellow { background-color: #ffc107; color: black; }
    .grade-red { background-color: #dc3545; color: white; }
    .highlight-total { background-color: #5a5a5a; color: white; }
    .signatures {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      font-size: 14px;
      padding: 0 20px;
    }
    .download-btn {
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .a4-container {
        width: 100%;
        height: auto;
        transform: scale(1);
        padding: 10px;
      }
      .scaled-content {
        transform: none;
      }
      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <h2>ุงูุงุณุชุนูุงู ุนู ูุชูุฌุฉ ุงูุทุงูุจ</h2>

  <label for="gradeFileSelector">ุงุฎุชุฑ ุงูุตู ุงูุฏุฑุงุณู:</label>
  <select id="gradeFileSelector" onchange="loadSelectedGradeFile()">
    <option value="">ุงุฎุชุฑ ุงูุตู ุงูุฏุฑุงุณู ูุชุญููู ููู ุงูุจูุงูุงุช</option>
    <option value="ุงูุงูู ุงูุงุจุชุฏุงุฆู">ุงูุฃูู ุงูุงุจุชุฏุงุฆู</option>
    <option value="ุงูุซุงูู ุงูุงุจุชุฏุงุฆู">ุงูุซุงูู ุงูุงุจุชุฏุงุฆู</option>
    <option value="ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู">ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู</option>
    <option value="ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู">ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู</option>
    <option value="ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู">ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู</option>
    <option value="ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู">ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู</option>
    <option value="ุงูุงูู ุงูุงุนุฏุงุฏู">ุงูุฃูู ุงูุฅุนุฏุงุฏู</option>
    <option value="ุงูุซุงูู ุงูุงุนุฏุงุฏู">ุงูุซุงูู ุงูุฅุนุฏุงุฏู</option>
    <option value="ุงูุซุงูุซ ุงูุงุนุฏุงุฏู">ุงูุซุงูุซ ุงูุฅุนุฏุงุฏู</option>
  </select>
  <br />

  <label for="yearSelector">ุงุฎุชุฑ ุงูุนุงู ุงูุฏุฑุงุณู:</label>
  <select id="yearSelector" onchange="loadSheet()">
    <option value="">ุงุฎุชุฑ ุนุงููุง ุฏุฑุงุณููุง</option>
  </select>
  <select id="searchType">
    <option value="ุงูุฅุณู" selected>ุจุญุซ ุจุงูุงุณู</option>
    <option value="ุฑูู ุงูุฌููุณ">ุจุญุซ ุจุฑูู ุงูุฌููุณ</option>
  </select>
  <input type="text" id="searchInput" placeholder="ุฃุฏุฎู ุงูุงุณู ุฃู ุฑูู ุงูุฌููุณ" list="nameSuggestions" />
  <datalist id="nameSuggestions"></datalist>
  <button onclick="search()">ุงุนุฑุถ ุงููุชูุฌุฉ</button>
  <select id="gradeFilter" onchange="filterByGrade()">
    <option value="">ุนุฑุถ ูุชูุฌุฉ ุตู ุฏุฑุงุณู ูุงูู </option>
  </select>
  <hr />
  <br />
  <button class="download-btn" onclick="downloadImage()">๐ธ ุชุญููู ูุทุจุงุนุฉ ุงููุชูุฌุฉ </button>
  <button class="download-btn" onclick="downloadPDF()">๐ ุชุญููู ุงููุชูุฌุฉ ูููู PDF</button>
  <button class="download-btn" onclick="downloadAndShareWhatsapp()">๐ข ุชุญููู ููุดุงุฑูุฉ ุนูู ูุงุชุณุงุจ</button>

  <div id="result"></div>

  <script>
    let sheetData = [];
    let maxGrades = {};
    let allWorksheets = {}; // ูุชุฎุฒูู ุฌููุน ุฃูุฑุงู ุงูุนูู
    let currentYear = ""; // ูุชุฎุฒูู ุงูุนุงู ุงูุฏุฑุงุณู ุงูุญุงูู
    let currentGradeFile = ""; // ูุชุบูุฑ ูุชุฎุฒูู ุงุณู ููู ุงูุตู ุงูุญุงูู

    function normalize(str) {
      return (str || "").replace(/ุฃ|ุฅ|ุข/g, "ุง").replace(/\s+/g, ' ').trim();
    }

    function getNextGrade(currentGrade) {
      const gradesOrder = [
        "ุงูุงูู ุงูุงุจุชุฏุงุฆู", "ุงูุซุงูู ุงูุงุจุชุฏุงุฆู", "ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู",
        "ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู", "ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู", "ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู",
        "ุงูุงูู ุงูุงุนุฏุงุฏู", "ุงูุซุงูู ุงูุงุนุฏุงุฏู", "ุงูุซุงูุซ ุงูุงุนุฏุงุฏู",
        "ุงูุงูู ุงูุซุงููู", "ุงูุซุงูู ุงูุซุงููู", "ุงูุซุงูุซ ุงูุซุงููู"
      ];
      const cleanGrade = normalize(currentGrade);
      const index = gradesOrder.findIndex(g => normalize(g) === cleanGrade);
      return (index !== -1 && index < gradesOrder.length - 1) ? gradesOrder[index + 1] : "โ";
    }

    function isPrimaryStage(grade) {
      return normalize(grade).includes("ุงูุงุจุชุฏุงุฆู");
    }

    function getPrimaryGradeText(percent) {
      if (percent >= 85) return "ุงุฒุฑู";
      else if (percent >= 65) return "ุงุฎุถุฑ";
      else if (percent >= 50) return "ุงุตูุฑ";
      else return "ุฃุญูุฑ";
    }

    function getSecondaryGradeText(percent) {
      if (percent >= 85) return "ููุชุงุฒ";
      else if (percent >= 75) return "ุฌูุฏ ุฌุฏุงู";
      else if (percent >= 65) return "ุฌูุฏ";
      else if (percent >= 50) return "ููุจูู";
      else return "ุฏูู ุงููุณุชูู";
    }

    // ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ ูุชุญุฏูุฏ ุงุณู ุงูููู ุจูุงุกู ุนูู ุงูุตู ุงููุฎุชุงุฑ ูููุทู ุงูุชุฌููุน
    function getFileNameForGrade(selectedGrade) {
        let fileName = '';
        const grade = normalize(selectedGrade);
        
        if (grade === normalize("ุงูุงูู ุงูุงุจุชุฏุงุฆู") || grade === normalize("ุงูุซุงูู ุงูุงุจุชุฏุงุฆู")) {
            fileName = "ุงูุฃูู ูุงูุซุงูู ุจ.xlsx";
        } else if (grade === normalize("ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู")) {
            fileName = "ุงูุซุงูุซ ุงูุงุจุชุฏุงุฆู.xlsx";
        } else if (
            grade === normalize("ุงูุฑุงุจุน ุงูุงุจุชุฏุงุฆู") ||
            grade === normalize("ุงูุฎุงูุณ ุงูุงุจุชุฏุงุฆู") ||
            grade === normalize("ุงูุณุงุฏุณ ุงูุงุจุชุฏุงุฆู")
        ) {
            fileName = "ุงูุฑุงุจุน ูุงูุฎุงูุณ ูุงูุณุงุฏุณ.xlsx";
        } else if (
            grade === normalize("ุงูุงูู ุงูุงุนุฏุงุฏู") ||
            grade === normalize("ุงูุซุงูู ุงูุงุนุฏุงุฏู") ||
            grade === normalize("ุงูุซุงูุซ ุงูุงุนุฏุงุฏู")
        ) {
            fileName = "ุงููุฑุญูุฉ ุงูุฅุนุฏุงุฏูุฉ.xlsx";
        }

        if (fileName) {
            // ุฅุถุงูุฉ ุงููุณุงุฑ ุงูุฌุฏูุฏ (ูููุฏุฑ Data)
            return `Data/${fileName}`; 
        }
        return '';
    }

    // ุฏุงูุฉ ููุนุงูุฌุฉ ููู ุงูุฅูุณู ุจุนุฏ ุชุญูููู
    function processWorkbook(workbook) {
        allWorksheets = {}; 
        const yearSelector = document.getElementById("yearSelector");
        yearSelector.innerHTML = '<option value="">ุงุฎุชุฑ ุนุงููุง ุฏุฑุงุณููุง</option>'; 
        
        workbook.SheetNames.forEach(sheetName => {
          allWorksheets[sheetName] = workbook.Sheets[sheetName];
          const option = document.createElement('option');
          option.value = sheetName;
          option.textContent = sheetName;
          yearSelector.appendChild(option);
        });

        if (workbook.SheetNames.length > 0) {
          yearSelector.value = workbook.SheetNames[0];
          loadSheet(); 
        }

        alert(`โ ุชู ุชุญููู ููู ุงูุจูุงูุงุช (${currentGradeFile || "ุงูููู"}) ุจูุฌุงุญ!`);
    }

    // ุฏุงูุฉ ุฌุฏูุฏุฉ ูุชุญููู ููู ุงูุฅูุณู ุจูุงุกู ุนูู ุงุฎุชูุงุฑ ุงูุตู
    async function loadSelectedGradeFile() {
        const gradeSelector = document.getElementById("gradeFileSelector");
        const selectedGrade = gradeSelector.value;
        
        // ูุณุญ ุงูุจูุงูุงุช ุงููุฏููุฉ ุนูุฏ ุชุบููุฑ ุงูุตู
        sheetData = [];
        allWorksheets = {};
        document.getElementById("yearSelector").innerHTML = '<option value="">ุงุฎุชุฑ ุนุงููุง ุฏุฑุงุณููุง</option>';
        document.getElementById("result").innerHTML = '';
        currentGradeFile = ""; 

        if (!selectedGrade) {
            return; 
        }

        const filePath = getFileNameForGrade(selectedGrade);
        
        if (!filePath) {
            alert("โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงุณู ููู ุฅูุณู ููุงุณุจ ููุตู ุงูุฏุฑุงุณู ุงููุฎุชุงุฑ.");
            return;
        }

        currentGradeFile = filePath; 

        try {
            // ุงุณุชุฎุฏุงู fetch API ูุชุญููู ููู ุงูุฅูุณู
            const response = await fetch(filePath);
            
            if (!response.ok) {
                // ุฑุณุงูุฉ ุฎุทุฃ ูู ุญุงู ุนุฏู ุงูุนุซูุฑ ุนูู ุงูููู
                throw new Error(`ูู ูุชู ุงูุนุซูุฑ ุนูู ููู: ${filePath}. ุชุฃูุฏ ูู ูุฌูุฏู ูู ูุฌูุฏ Data.`);
            }

            const data = await response.arrayBuffer();
            const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
            
            processWorkbook(workbook);

        } catch (error) {
            alert("โ ุฎุทุฃ ูู ุชุญููู ููู ุงูุฅูุณู. ุชุญูู ูู ุงุณู ุงูููู ูุงููุณุงุฑ ูู ูุฌูุฏ Data. \n" + error.message);
            console.error(error);
        }
    }
    
    // ุชู ุญุฐู ููุฏ "document.getElementById('upload').addEventListener('change', ..."

    // ุฏุงูุฉ ูุชุญููู ุจูุงูุงุช ูุฑูุฉ ุงูุนูู ุงููุญุฏุฏุฉ ูุชุญุฏูุซ ุนูุงุตุฑ ุงูุตูุญุฉ
    function loadSheet() {
      const yearSelector = document.getElementById("yearSelector");
      const sheetName = yearSelector.value;
      if (!sheetName) {
          sheetData = []; // ูุณุญ ุงูุจูุงูุงุช ุนูุฏ ุนุฏู ุงุฎุชูุงุฑ ุนุงู ุฏุฑุงุณู
          maxGrades = {};
          document.getElementById("nameSuggestions").innerHTML = '';
          document.getElementById("gradeFilter").innerHTML = '<option value=""> ุนุฑุถ ูุชูุฌุฉ ุตู ุฏุฑุงุณู ูุงูู </option>';
          document.getElementById("result").innerHTML = '';
          // ููุงุญุธุฉ: ูุง ููุฌุฏ ุนูุตุฑ ุจู ID "pageTitle" ูู HTML ุงูุญุงููุ ูุฐุง ููุช ุจุฅุฒุงูุชู ูู ููุง.
          currentYear = "";
          return;
      }

      currentYear = sheetName;
      // ุชุญุฏูุซ ุนููุงู ุงูุตูุญุฉ ุจุงูุนุงู ุงูุฏุฑุงุณู ุงููุฎุชุงุฑ (ูุชู ุชุญุฏูุซู ูู ุจุทุงูุฉ ุงููุชูุฌุฉ)

      const worksheet = allWorksheets[sheetName];

      const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      const headers = rawData[0];
      const secondRow = rawData[1];
      maxGrades = {};
      headers.forEach((key, index) => {
        if (key && typeof secondRow[index] === 'number') {
          maxGrades[key] = secondRow[index];
        }
      });

      const studentData = rawData.slice(2);
      sheetData = studentData.map(row => {
        const obj = {};
        headers.forEach((key, i) => obj[key] = row[i]);
        return obj;
      });

      // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงูุชุฑุงุญุงุช (datalist)
      const datalist = document.getElementById("nameSuggestions");
      datalist.innerHTML = '';
      sheetData.forEach(student => {
        if (student["ุงูุฅุณู"]) {
          const option = document.createElement('option');
          option.value = student["ุงูุฅุณู"];
          datalist.appendChild(option);
        }
      });

      // ุชุญุฏูุซ ููุชุฑ ุงูุตู ุงูุฏุฑุงุณู
      const gradeFilter = document.getElementById("gradeFilter");
      const uniqueGrades = [...new Set(sheetData.map(s => s["ุงูุตู"]).filter(Boolean))];
      gradeFilter.innerHTML = `<option value=""> ุนุฑุถ ูุชูุฌุฉ ุตู ุฏุฑุงุณู ูุงูู </option>`;
      uniqueGrades.forEach(grade => {
        const option = document.createElement("option");
        option.value = grade;
        option.textContent = grade;
        gradeFilter.appendChild(option);
      });
      document.getElementById('result').innerHTML = ''; // ูุณุญ ุงููุชุงุฆุฌ ุงููุนุฑูุถุฉ ุนูุฏ ุชุบููุฑ ุงูุนุงู
    }

    function getGradeClass(percent) {
      if (percent >= 85) return "grade-blue";
      else if (percent >= 65) return "grade-green";
      else if (percent >= 50) return "grade-yellow";
      else return "grade-red";
    }

    function generateStudentCard(student) {
      const ignoredKeys = ["ุฑูู ุงูุฌููุณ", "ุงูุฅุณู", "ุชุฑุชูุจ ุงูุทุงูุจ", "ุงูุตู"];
      const subjects = Object.keys(student).filter(k => !ignoredKeys.includes(k));
      const nextGrade = getNextGrade(student["ุงูุตู"]);
      const allSubjects = [...subjects];

      let html = `<div class="a4-container" id="card-result"><div class="scaled-content">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
          <div style="text-align: right;">
            <h3 style="margin: 0;">ุฅุฏุงุฑุฉ ุงููููุง ุงูุชุนููููุฉ</h3>
            <h4 style="margin: 0;">ูุฏุฑุณุฉ ุตูุงุญ ุงูุฏูู ุงูุฅุณูุงููุฉ ุงูุฎุงุตุฉ</h4>
          </div>
          <div>
<img src="
              
                        " alt="ููุฌู ุงููุฏุฑุณุฉ" style="height: 80px;" />
          </div>
        </div>
        <h3 id="pageTitle" style="text-align: center;">ุจูุงู ุฏุฑุฌุงุช ุงูุทุงูุจ ููุนุงู ุงูุฏุฑุงุณู ${currentYear || "2023-2024"}</h3>
        <div class="info"><strong>ุงูุงุณู:</strong> ${student["ุงูุฅุณู"]}</div>
        <div class="info"><strong>ุฑูู ุงูุฌููุณ:</strong> ${student["ุฑูู ุงูุฌููุณ"]}</div>
        <div class="info"><strong>ุงูุตู ุงูุฏุฑุงุณู:</strong> ${student["ุงูุตู"]}</div>
        <table>
          <tr>
            <th>ุงููุงุฏุฉ</th>
            ${allSubjects.map(sub => `<th>${sub}</th>`).join('')}
          </tr>
          <tr>
            <td>ุงูููุงุฆูุฉ ุงููุจุฑู</td>
            ${allSubjects.map(sub => {
              const val = maxGrades[sub] || '-';
              return sub === "ุงููุฌููุน"
                ? `<td class="highlight-total">${val}</td>`
                : `<td>${val}</td>`;
            }).join('')}
          </tr>
          <tr>
            <td>ุงูููุงุฆูุฉ ุงูุตุบุฑู</td>
            ${allSubjects.map(sub => {
              const val = maxGrades[sub] ? maxGrades[sub] / 2 : '-';
              return sub === "ุงููุฌููุน"
                ? `<td class="highlight-total">${val}</td>`
                : `<td>${val}</td>`;
            }).join('')}
          </tr>
          <tr>
            <td>ุฏุฑุฌุฉ ุงูุทุงูุจ</td>
            ${allSubjects.map(sub => {
              const value = typeof student[sub] === 'number' ? student[sub].toFixed(2) : student[sub];
              return sub === "ุงููุฌููุน"
                ? `<td class="highlight-total">${value}</td>`
                : `<td>${value}</td>`;
            }).join('')}
          </tr>
          <tr>
            <td>ุงูุชูุฏูุฑ</td>
            ${allSubjects.map(sub => {
              const mark = parseFloat(student[sub]);
              const max = maxGrades[sub] || 100;
              const percent = (mark / max) * 100;
              const text = isPrimaryStage(student["ุงูุตู"])
                ? getPrimaryGradeText(percent)
                : getSecondaryGradeText(percent);
              const className = getGradeClass(percent);
              return `<td class="${className}">${text}</td>`;
            }).join('')}
          </tr>
          <tr>
            <td colspan="${allSubjects.length + 1}" style="background: #d4edda; color: #155724; font-weight: bold;">
              โ ุงูุทุงูุจ ูุงุฌุญ ูููููู ุฅูู ุงูุตู ${nextGrade}
            </td>
          </tr>
        </table>
        <div class="signatures">
          <div>ู. ุงูุญุงุณุจ<br><strong>ุงูุญุณู ุฃุญูุฏ</strong></div>
          <div>ุฑุฆูุณ ูุฌูุฉ ุงููุธุงู ูุงููุฑุงูุจุฉ<br><strong>ุจุฏุฑ ุงูุฏูู ุญุจุดู</strong></div>
          <div>ูุฏูุฑ ุงููุฏุฑุณุฉ<br><strong>ุจูุงุก ุงูุฏูู ูุญูุฏ</strong></div>
        </div>
      </div></div>`;

      return html;
    }

    function search() {
      const type = document.getElementById('searchType').value;
      const value = document.getElementById('searchInput').value.trim();
      if (!value) return alert("ูู ูุถูู ุฃุฏุฎู ูููุฉ ููุจุญุซ");
      if (sheetData.length === 0) return alert("ูู ูุถูู ูู ุจุชุญููู ููู Excel ูุงุฎุชุฑ ุนุงููุง ุฏุฑุงุณููุง ุฃููุงู.");
      
      const student = sheetData.find(row => 
        type === "ุฑูู ุงูุฌููุณ" ? row["ุฑูู ุงูุฌููุณ"]?.toString() === value : 
        row["ุงูุฅุณู"] && normalize(row["ุงูุฅุณู"]).includes(normalize(value))
      );
      document.getElementById('result').innerHTML = student ? generateStudentCard(student) : "<p>โ ูุง ููุฌุฏ ุทุงูุจ ุจูุฐู ุงูุจูุงูุงุช ูู ุงูุนุงู ุงูุฏุฑุงุณู ุงููุญุฏุฏ.</p>";
    }

    function filterByGrade() {
      const selectedGrade = document.getElementById("gradeFilter").value;
      if (sheetData.length === 0) return alert("ูู ูุถูู ูู ุจุชุญููู ููู Excel ูุงุฎุชุฑ ุนุงููุง ุฏุฑุงุณููุง ุฃููุงู.");
      if (!selectedGrade) {
          document.getElementById("result").innerHTML = "";
          return;
      }
      const filtered = sheetData.filter(s => s["ุงูุตู"] === selectedGrade);
      document.getElementById("result").innerHTML = filtered.length === 0 ? "<p>โ ูุง ููุฌุฏ ุทูุงุจ ูู ูุฐุง ุงูุตู ููุนุงู ุงูุฏุฑุงุณู ุงููุญุฏุฏ.</p>" : filtered.map(generateStudentCard).join('');
    }

  function downloadImage() {
  const card = document.getElementById("card-result");
  if (!card) return alert("ูู ูุถูู ุงุนุฑุถ ุงููุชูุฌุฉ ุฃููุง");

  const studentName = (document.querySelector('.info')?.innerText || 'ุงูุทุงูุจ')
    .replace('ุงูุงุณู:', '').trim();

  html2canvas(card, { scale: 2 }).then(canvas => {
    // ุชุญููู ุงูุตูุฑุฉ
    const link = document.createElement('a');
    link.download = `${studentName}.png`;
    link.href = canvas.toDataURL();
    link.click();

    // ูุชุญ ูุงูุฐุฉ ุฌุฏูุฏุฉ ูุชุญููู ุงูุตูุฑุฉ ูููุง ููุทุจุงุนุฉ
    const imgWindow = window.open('', '_blank');
    const img = new Image();
    img.src = canvas.toDataURL();
    img.style.maxWidth = '100%';

    img.onload = function () {
      imgWindow.document.write(
        `<html>
          <head>
            <title style="color:white;"> ู</title>
            <style>
              @page { margin-top: 10mm; margin-left: 0; margin-right: 0; margin-bottom: 0; }
              body { margin:0; text-align:center; }
              title { color: white !important; }
            </style>
          </head>
          <body>
          </body>
        </html>`
      );
      imgWindow.document.body.appendChild(img);
      imgWindow.document.close();
      imgWindow.print();
    };
  });
}


    function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const card = document.getElementById("card-result");
  if (!card) return alert("ูู ูุถูู ุงุนุฑุถ ุงููุชูุฌุฉ ุฃููุง");
  const studentName = (document.querySelector('.info')?.innerText || 'ุงูุทุงูุจ').replace('ุงูุงุณู:', '').trim();
  html2canvas(card, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save(`${studentName}.pdf`);
  });
}


function downloadAndShareWhatsapp() {
  const card = document.getElementById("card-result");
  if (!card) return alert("ูู ูุถูู ุงุนุฑุถ ุงููุชูุฌุฉ ุฃููุง");

  // ูุฌูุจ ุงุณู ุงูุทุงูุจ
  const studentName = (document.querySelector('.info strong')?.innerText || 'ุงูุทุงูุจ').replace('ุงูุงุณู:', '').trim();

  html2canvas(card, { scale: 2 }).then(canvas => {
    // ูุญูู ุงูุตูุฑุฉ
    const link = document.createElement('a');
    link.download = `${studentName}.png`;
    link.href = canvas.toDataURL();
    link.click();

    // ููุชุญ ูุงุชุณุงุจ ุจุงูุฑุณุงูุฉ ุงูุงูุชุฑุงุถูุฉ
    setTimeout(() => {
      const message = encodeURIComponent(`๐ ูุชูุฌุฉ ุงูุทุงูุจ: ${studentName}`);
      window.open(`https://wa.me/?text=${message}`, '_blank');
    }, 1000);
  });
}


  </script>
</body>
</html>
