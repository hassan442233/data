<!DOCTYPE html> 
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title id="pageTitle">Ø¨ÙŠØ§Ù† Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„ØµÙÙˆÙ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/xlsx.full.min.js';
            document.head.appendChild(script);
        }
    </script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        if (typeof html2canvas === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/html2canvas.min.js';
            document.head.appendChild(script);
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        if (typeof jspdf === 'undefined') {
            const script = document.createElement('script');
            script.src = 'js/jspdf.umd.min.js';
            document.head.appendChild(script);
        }
    </script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f0f0f0;
      padding: 20px;
      text-align: center;
    }
    input, select, button {
      margin: 10px;
      padding: 12px 20px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .a4-container {
      width: 210mm;
      height: 297mm;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
      transform-origin: top center;
    }
    .scaled-content {
      width: 100%;
      height: 100%;
      transform: scale(0.85);
      transform-origin: top center;
    }
    h3, h4 {
      margin: 10px 0;
      color: #333;
    }
    .info {
      text-align: right;
      font-size: 16px;
      margin: 5px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #343a40;
      color: white;
    }
    .grade-blue { background-color: #007bff; color: white; }
    .grade-green { background-color: #28a745; color: white; }
    .grade-yellow { background-color: #ffc107; color: black; }
    .grade-red { background-color: #dc3535; color: white; }
    .highlight-total { background-color: #5a5a5a; color: white; }
    .signatures {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      font-size: 14px;
      padding: 0 20px;
    }
    .download-btn {
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .a4-container {
        width: 100%;
        height: auto;
        transform: scale(1);
        padding: 10px;
      }
      .scaled-content {
        transform: none;
      }
      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <h2>Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>

  <label for="gradeFileSelector">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</label>
  <select id="gradeFileSelector" onchange="loadSelectedGradeFile()">
      <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
      <option value="Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      <option value="Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      <option value="Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      <option value="Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      <option value="Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
      <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
      <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
  </select>

  <br />
  <label for="yearSelector">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ (ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„):</label>
  <select id="yearSelector" onchange="loadSheet()">
    <option value="">Ø§Ø®ØªØ± Ø¹Ø§Ù…Ù‹Ø§ Ø¯Ø±Ø§Ø³ÙŠÙ‹Ø§</option>
  </select>
  <select id="searchType">
    <option value="Ø§Ù„Ø¥Ø³Ù…" selected>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</option>
    <option value="Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³">Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</option>
  </select>
  <input type="text" id="searchInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³" list="nameSuggestions" />
  <datalist id="nameSuggestions"></datalist>
  <button onclick="search()">Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
  <select id="gradeFilter" onchange="filterByGrade()">
    <option value="">Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© ØµÙ Ø¯Ø±Ø§Ø³ÙŠ ÙƒØ§Ù…Ù„ </option>
  </select>
  <hr />
  <br />
  <button class="download-btn" onclick="downloadImage()">ğŸ“¸ ØªØ­Ù…ÙŠÙ„ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© </button>
  <button class="download-btn" onclick="downloadPDF()">ğŸ“• ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒÙ…Ù„Ù PDF</button>
  <button class="download-btn" onclick="downloadAndShareWhatsapp()">ğŸŸ¢ ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</button>

  <div id="result"></div>

  <script>
    let sheetData = [];
    let maxGrades = {};
    let allWorksheets = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„
    let currentYear = ""; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
    let currentGradeFile = ""; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ù„ÙŠ

    function normalize(str) {
      return (str || "").replace(/Ø£|Ø¥|Ø¢/g, "Ø§").replace(/\s+/g, ' ').trim();
    }

    function getNextGrade(currentGrade) {
      const gradesOrder = [
        "Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
        "Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
        "Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ",
        "Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"
      ];
      const cleanGrade = normalize(currentGrade);
      const index = gradesOrder.findIndex(g => normalize(g) === cleanGrade);
      return (index !== -1 && index < gradesOrder.length - 1) ? gradesOrder[index + 1] : "â€”";
    }

    function isPrimaryStage(grade) {
      return normalize(grade).includes("Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ");
    }

    function getPrimaryGradeText(percent) {
      if (percent >= 85) return "Ø§Ø²Ø±Ù‚";
      else if (percent >= 65) return "Ø§Ø®Ø¶Ø±";
      else if (percent >= 50) return "Ø§ØµÙØ±";
      else return "Ø£Ø­Ù…Ø±";
    }

    function getSecondaryGradeText(percent) {
      if (percent >= 85) return "Ù…Ù…ØªØ§Ø²";
      else if (percent >= 75) return "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹";
      else if (percent >= 65) return "Ø¬ÙŠØ¯";
      else if (percent >= 50) return "Ù…Ù‚Ø¨ÙˆÙ„";
      else return "Ø¯ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙˆÙ‰";
    }
    
    // Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙˆÙ…Ù†Ø·Ù‚ Ø§Ù„ØªØ¬Ù…ÙŠØ¹
    function getFileNameForGrade(selectedGrade) {
        let fileName = '';
        const grade = normalize(selectedGrade);
        
        if (grade === normalize("Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ") || grade === normalize("Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ")) {
            // Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
            fileName = "Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø«Ø§Ù†ÙŠ Ø¨.xlsx";
        } else if (grade === normalize("Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ")) {
            // Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
            fileName = "Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ.xlsx";
        } else if (
            grade === normalize("Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ") ||
            grade === normalize("Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ") ||
            grade === normalize("Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ")
        ) {
            // Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø£Ùˆ Ø§Ù„Ø®Ø§Ù…Ø³ Ø£Ùˆ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
            fileName = "Ø§Ù„Ø±Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø®Ø§Ù…Ø³ ÙˆØ§Ù„Ø³Ø§Ø¯Ø³.xlsx";
        } else if (
            grade === normalize("Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ") ||
            grade === normalize("Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ") ||
            grade === normalize("Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ")
        ) {
            // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©
            fileName = "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©.xlsx";
        }

        if (fileName) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ÙÙˆÙ„Ø¯Ø± Data)
            return `Data/${fileName}`; 
        }
        return '';
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„Ù‡
    function processWorkbook(workbook) {
        allWorksheets = {}; 
        const yearSelector = document.getElementById("yearSelector");
        yearSelector.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¹Ø§Ù…Ù‹Ø§ Ø¯Ø±Ø§Ø³ÙŠÙ‹Ø§</option>'; 
        
        workbook.SheetNames.forEach(sheetName => {
          allWorksheets[sheetName] = workbook.Sheets[sheetName];
          const option = document.createElement('option');
          option.value = sheetName;
          option.textContent = sheetName;
          yearSelector.appendChild(option);
        });

        if (workbook.SheetNames.length > 0) {
          yearSelector.value = workbook.SheetNames[0];
          loadSheet(); 
        }

        alert(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (${currentGradeFile}) Ø¨Ù†Ø¬Ø§Ø­!`);
    }

    // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ
    async function loadSelectedGradeFile() {
        const gradeSelector = document.getElementById("gradeFileSelector");
        const selectedGrade = gradeSelector.value;
        
        // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ
        sheetData = [];
        allWorksheets = {};
        document.getElementById("yearSelector").innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¹Ø§Ù…Ù‹Ø§ Ø¯Ø±Ø§Ø³ÙŠÙ‹Ø§</option>';
        document.getElementById("result").innerHTML = '';
        currentGradeFile = ""; 

        if (!selectedGrade) {
            return; 
        }

        const filePath = getFileNameForGrade(selectedGrade);
        
        if (!filePath) {
            alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ù…Ù„Ù Ø¥ÙƒØ³Ù„ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù…Ø®ØªØ§Ø±.");
            return;
        }

        currentGradeFile = filePath; 

        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch API Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„
            const response = await fetch(filePath);
            
            if (!response.ok) {
                // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù
                throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù: ${filePath}. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡ ÙÙŠ Ù…Ø¬Ù„Ø¯ Data.`);
            }

            const data = await response.arrayBuffer();
            const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
            
            processWorkbook(workbook);

        } catch (error) {
            alert("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„Ù…Ø³Ø§Ø± ÙÙŠ Ù…Ø¬Ù„Ø¯ Data. \n" + error.message);
            console.error(error);
        }
    }


    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
    function loadSheet() {
      const yearSelector = document.getElementById("yearSelector");
      const sheetName = yearSelector.value;
      if (!sheetName) {
          sheetData = []; 
          maxGrades = {};
          document.getElementById("nameSuggestions").innerHTML = '';
          document.getElementById("gradeFilter").innerHTML = '<option value=""> Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© ØµÙ Ø¯Ø±Ø§Ø³ÙŠ ÙƒØ§Ù…Ù„ </option>';
          document.getElementById("result").innerHTML = '';
          const gradeSelector = document.getElementById("gradeFileSelector");
          const selectedGradeName = gradeSelector.options[gradeSelector.selectedIndex].text;
          document.getElementById("pageTitle").textContent = `Ø¨ÙŠØ§Ù† Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„ØµÙÙˆÙ`;
          currentYear = "";
          return;
      }

      currentYear = sheetName;
      // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù…Ø®ØªØ§Ø±
      const pageTitleElement = document.getElementById("pageTitle");
      const gradeSelector = document.getElementById("gradeFileSelector");
      const selectedGradeName = gradeSelector.options[gradeSelector.selectedIndex].text;
      
      if (pageTitleElement) { 
          pageTitleElement.textContent = `Ø¨ÙŠØ§Ù† Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„ØµÙ ${selectedGradeName} Ù„Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ${currentYear}`;
      }

      const worksheet = allWorksheets[sheetName];

      const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      const headers = rawData[0];
      const secondRow = rawData[1];
      maxGrades = {};
      headers.forEach((key, index) => {
        if (key && typeof secondRow[index] === 'number') {
          maxGrades[key] = secondRow[index];
        }
      });

      const studentData = rawData.slice(2);
      sheetData = studentData.map(row => {
        const obj = {};
        headers.forEach((key, i) => obj[key] = row[i]);
        return obj;
      });

      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª (datalist)
      const datalist = document.getElementById("nameSuggestions");
      datalist.innerHTML = '';
      sheetData.forEach(student => {
        if (student["Ø§Ù„Ø¥Ø³Ù…"]) {
          const option = document.createElement('option');
          option.value = student["Ø§Ù„Ø¥Ø³Ù…"];
          datalist.appendChild(option);
        }
      });

      // ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
      const gradeFilter = document.getElementById("gradeFilter");
      const uniqueGrades = [...new Set(sheetData.map(s => s["Ø§Ù„ØµÙ"]).filter(Boolean))];
      gradeFilter.innerHTML = `<option value=""> Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© ØµÙ Ø¯Ø±Ø§Ø³ÙŠ ÙƒØ§Ù…Ù„ </option>`;
      uniqueGrades.forEach(grade => {
        const option = document.createElement("option");
        option.value = grade;
        option.textContent = grade;
        gradeFilter.appendChild(option);
      });
      document.getElementById('result').innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ù…
    }

    function getGradeClass(percent) {
      if (percent >= 85) return "grade-blue";
      else if (percent >= 65) return "grade-green";
      else if (percent >= 50) return "grade-yellow";
      else return "grade-red";
    }

    function generateStudentCard(student) {
      const ignoredKeys = ["Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³", "Ø§Ù„Ø¥Ø³Ù…", "ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø§Ù„Ø¨", "Ø§Ù„ØµÙ"];
      const subjects = Object.keys(student).filter(k => !ignoredKeys.includes(k));
      const nextGrade = getNextGrade(student["Ø§Ù„ØµÙ"]);
      const allSubjects = [...subjects];

      let html = `<div class="a4-container" id="card-result"><div class="scaled-content">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
          <div style="text-align: right;">
            <h3 style="margin: 0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠØ§ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h3>
            <h4 style="margin: 0;">Ù…Ø¯Ø±Ø³Ø© ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ©</h4>
          </div>
          <div>
              </div>
        </div>
        <hr style="border: 1px solid #000;"/>
        <div style="text-align: right; padding: 0 10px;">
          <p class="info"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${student["Ø§Ù„Ø¥Ø³Ù…"] || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
          <p class="info"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³:</strong> ${student["Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³"] || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
          <p class="info"><strong>Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</strong> ${student["Ø§Ù„ØµÙ"] || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
          <p class="info"><strong>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ:</strong> ${student["ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø§Ù„Ø¨"] || 'â€”'}</p>
          <p class="info"><strong>Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</strong> ${currentYear || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</p>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
              <th>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</th>
              <th>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</th>
              <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
            </tr>
          </thead>
          <tbody>`;

      let totalScore = 0;
      let maxTotalScore = 0;

      subjects.forEach(subject => {
        const score = student[subject] || 0;
        const max = maxGrades[subject] || 1;
        const percent = (score / max) * 100;
        const gradeClass = getGradeClass(percent);
        const gradeText = isPrimaryStage(student["Ø§Ù„ØµÙ"]) ? getPrimaryGradeText(percent) : getSecondaryGradeText(percent);

        totalScore += parseFloat(score) || 0;
        maxTotalScore += parseFloat(max) || 0;

        html += `<tr>
              <td style="text-align: right;">${subject}</td>
              <td>${max}</td>
              <td>${score}</td>
              <td class="${gradeClass}"><strong>${gradeText}</strong></td>
            </tr>`;
      });

      const overallPercent = maxTotalScore > 0 ? (totalScore / maxTotalScore) * 100 : 0;
      const overallGradeText = isPrimaryStage(student["Ø§Ù„ØµÙ"]) ? getPrimaryGradeText(overallPercent) : getSecondaryGradeText(overallPercent);
      const overallGradeClass = getGradeClass(overallPercent);

      html += `
            <tr class="highlight-total">
              <td style="text-align: right;"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</strong></td>
              <td><strong>${maxTotalScore}</strong></td>
              <td><strong>${totalScore}</strong></td>
              <td class="${overallGradeClass}"><strong>${overallGradeText} (${overallPercent.toFixed(2)}%)</strong></td>
            </tr>
            <tr>
              <td style="text-align: right;"><strong>Ø§Ù„Ø­Ø§Ù„Ø©</strong></td>
              <td colspan="3" style="font-size: 16px;"><strong>${overallPercent >= 50 ? 'Ù†Ø§Ø¬Ø­' : 'Ø±Ø§Ø³Ø¨'}</strong></td>
            </tr>
            <tr>
              <td style="text-align: right;"><strong>Ø§Ù„Ù…Ù†Ù‚ÙˆÙ„ Ø¥Ù„Ù‰</strong></td>
              <td colspan="3" style="font-size: 16px;"><strong>${overallPercent >= 50 ? nextGrade : 'â€”'}</strong></td>
            </tr>
          </tbody>
        </table>

        <div class="signatures">
          <span>ØªÙˆÙ‚ÙŠØ¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ............................</span>
          <span>ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ............................</span>
        </div>
        <p style="position: absolute; bottom: 20px; left: 20px; font-size: 10px;">
          ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })}
        </p>

      </div></div>`;

      document.getElementById('result').innerHTML = html;
      
      const shareText = `Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨: ${student["Ø§Ù„Ø¥Ø³Ù…"]} - Ø§Ù„ØµÙ: ${student["Ø§Ù„ØµÙ"]} - Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${totalScore} Ù…Ù† ${maxTotalScore} - Ø§Ù„ØªÙ‚Ø¯ÙŠØ±: ${overallGradeText} - Ø§Ù„Ù†Ø³Ø¨Ø©: ${overallPercent.toFixed(2)}%`;
      document.querySelector('button[onclick="downloadAndShareWhatsapp()"]').setAttribute('data-share-text', shareText);
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« (Ù„Ù… ØªØªØºÙŠØ±)
    function search() {
      const input = document.getElementById("searchInput").value.trim();
      const searchType = document.getElementById("searchType").value;
      if (!input || sheetData.length === 0) {
        document.getElementById("result").innerHTML = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¨Ø­Ø« ÙˆØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.';
        return;
      }

      const normalizedInput = normalize(input);

      const student = sheetData.find(s => {
        if (searchType === "Ø§Ù„Ø¥Ø³Ù…") {
          return normalize(s["Ø§Ù„Ø¥Ø³Ù…"]) === normalizedInput;
        } else if (searchType === "Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³") {
          return String(s["Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³"]) === normalizedInput;
        }
        return false;
      });

      if (student) {
        generateStudentCard(student);
      } else {
        document.getElementById("result").innerHTML = '<h3>âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø§Ù„Ø§Ø³Ù…/Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³ Ø§Ù„Ù…Ø¯Ø®Ù„.</h3>';
      }
    }
    
    // Ø¯Ø§Ù„Ø© ÙÙ„ØªØ±Ø© Ø§Ù„ØµÙÙˆÙ (Ù„Ù… ØªØªØºÙŠØ±)
    function filterByGrade() {
        const grade = document.getElementById("gradeFilter").value;
        if (!grade) {
            document.getElementById("result").innerHTML = '';
            return;
        }

        const filteredStudents = sheetData.filter(s => s["Ø§Ù„ØµÙ"] === grade);

        if (filteredStudents.length > 0) {
            let tableHtml = `<div class="a4-container" style="height: auto; width: 80%;"><div class="scaled-content" style="transform: none;">
                <h3 style="text-align: center;">Ù†ØªØ§Ø¦Ø¬ Ø·Ù„Ø§Ø¨ Ø§Ù„ØµÙ: ${grade} Ù„Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: ${currentYear}</h3>
                <table style="margin-bottom: 20px;"><thead><tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</th>
                    <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                    <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</th>
                    <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                </tr></thead><tbody>`;

            filteredStudents.forEach(student => {
                const ignoredKeys = ["Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³", "Ø§Ù„Ø¥Ø³Ù…", "ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø§Ù„Ø¨", "Ø§Ù„ØµÙ"];
                const subjects = Object.keys(student).filter(k => !ignoredKeys.includes(k));
                let totalScore = 0;
                let maxTotalScore = 0;

                subjects.forEach(subject => {
                    const score = student[subject] || 0;
                    const max = maxGrades[subject] || 1;
                    totalScore += parseFloat(score) || 0;
                    maxTotalScore += parseFloat(max) || 0;
                });

                const overallPercent = maxTotalScore > 0 ? (totalScore / maxTotalScore) * 100 : 0;
                const overallGradeText = isPrimaryStage(grade) ? getPrimaryGradeText(overallPercent) : getSecondaryGradeText(overallPercent);
                const overallGradeClass = getGradeClass(overallPercent);

                tableHtml += `<tr>
                    <td style="text-align: right;">${student["Ø§Ù„Ø¥Ø³Ù…"] || 'â€”'}</td>
                    <td>${student["Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³"] || 'â€”'}</td>
                    <td>${student["ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø§Ù„Ø¨"] || 'â€”'}</td>
                    <td>${totalScore} / ${maxTotalScore}</td>
                    <td class="${overallGradeClass}"><strong>${overallGradeText} (${overallPercent.toFixed(2)}%)</strong></td>
                </tr>`;
            });

            tableHtml += `</tbody></table></div></div>`;
            document.getElementById('result').innerHTML = tableHtml;
        } else {
            document.getElementById("result").innerHTML = '<h3>âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ.</h3>';
        }
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù„Ù… ØªØªØºÙŠØ±)
    function downloadImage() {
      const card = document.getElementById("card-result");
      if (!card) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£ÙˆÙ„Ø§");
      const studentName = (document.querySelector('.info')?.innerText || 'Ø§Ù„Ø·Ø§Ù„Ø¨').replace('Ø§Ù„Ø§Ø³Ù…:', '').trim();
      html2canvas(card, { scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = `${studentName}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }

    function printResult() {
      const card = document.getElementById("card-result");
      if (!card) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£ÙˆÙ„Ø§");
      html2canvas(card, { scale: 2 }).then(canvas => {
        const img = canvas.toDataURL('image/png');
        const imgWindow = window.open('about:blank', 'printWindow', 'width=800,height=600');
        imgWindow.document.write('<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©</title><style>@page { size: A4; margin: 0; } body { margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }</style></head><body><img src="' + img + '" style="max-width: 210mm; max-height: 297mm;" onload="window.print();window.close()"/></body></html>');
        imgWindow.document.close();
      });
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const card = document.getElementById("card-result");
      if (!card) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£ÙˆÙ„Ø§");
      const studentName = (document.querySelector('.info')?.innerText || 'Ø§Ù„Ø·Ø§Ù„Ø¨').replace('Ø§Ù„Ø§Ø³Ù…:', '').trim();
      html2canvas(card, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`${studentName}.pdf`);
      });
    }

    function downloadAndShareWhatsapp() {
      const card = document.getElementById("card-result");
      if (!card) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£ÙˆÙ„Ø§");

      // Ù†Ø¬Ù„Ø¨ Ù†Øµ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯Ù‡ ÙÙŠ Ø¯Ø§Ù„Ø© generateStudentCard
      const shareText = document.querySelector('button[onclick="downloadAndShareWhatsapp()"]').getAttribute('data-share-text') || "Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨";
      
      // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¹Ø§Ø¡ Ù„Ù„ØµÙˆØ±Ø© Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨ (ÙŠØªØ·Ù„Ø¨ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§)
      html2canvas(card, { scale: 2 }).then(canvas => {
        canvas.toBlob(blob => {
          if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'result.png', { type: blob.type })] })) {
            const file = new File([blob], 'result.png', { type: blob.type });
            navigator.share({
              files: [file],
              title: 'Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨',
              text: shareText
            }).catch((error) => console.log('Sharing failed', error));
          } else {
            // Ø­Ù„ Ø¨Ø¯ÙŠÙ„: ÙØªØ­ Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ù†Øµ ÙÙ‚Ø·
            const whatsappLink = `https://wa.me/?text=${encodeURIComponent(shareText + "\n\n(Ù„Ù„Ø£Ø³Ù Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø®Ø§Øµ Ø¨ÙƒØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„Ù‡Ø§ ÙˆÙ…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹.)")}`;
            window.open(whatsappLink, '_blank');
          }
        }, 'image/png');
      });
    }
  </script>
</body>
</html>